@model List<DoableFinal.Models.Ticket>

@{
    ViewBag.Title = "Tickets";
    var query = Context.Request.Query["q"].ToString();
    var statusFilter = Context.Request.Query["statusFilter"].ToString();
    var fromDate = Context.Request.Query["fromDate"].ToString();
    var toDate = Context.Request.Query["toDate"].ToString();
}

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Support Tickets</h1>
            <p class="text-muted small mb-0">Manage and track all support tickets</p>
        </div>
        <span class="badge bg-primary fs-6">@(Model?.Count ?? 0) Tickets</span>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters & Search</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3" role="search" aria-label="Ticket search and filter">
                <div class="col-md-6">
                    <label for="searchInput" class="form-label">Search</label>
                    <input type="search" id="searchInput" name="q" class="form-control" placeholder="Search by title or creator..." value="@query" aria-label="Search tickets" />
                </div>

                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select id="statusFilter" name="statusFilter" class="form-select">
                        <option value="">All statuses</option>
                        @foreach (var s in (List<string>)ViewBag.AvailableStatuses)
                        {
                            if (statusFilter == s || ViewBag.StatusFilter == s)
                            {
                                <option value="@s" selected>@s</option>
                            }
                            else
                            {
                                <option value="@s">@s</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="applyBtn" class="form-label">&nbsp;</label>
                    <button id="applyBtn" class="btn btn-primary w-100" type="submit">
                        <i class="bi bi-search"></i> Apply Filters
                    </button>
                </div>

                <div class="col-12">
                    <hr class="my-2" />
                </div>

                <div class="col-md-4">
                    <label for="fromDate" class="form-label"><i class="bi bi-calendar-event"></i> From Date</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control" value="@fromDate" aria-label="From date" />
                </div>

                <div class="col-md-4">
                    <label for="toDate" class="form-label"><i class="bi bi-calendar-event"></i> To Date</label>
                    <input type="date" id="toDate" name="toDate" class="form-control" value="@toDate" aria-label="To date" />
                </div>

                <div class="col-md-4">
                    <label for="applyDateBtn" class="form-label">&nbsp;</label>
                    <button id="applyDateBtn" class="btn btn-outline-primary w-100" type="submit">
                        <i class="bi bi-calendar3"></i> Apply Date Range
                    </button>
                </div>

                <div class="col-12 text-end">
                    <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Tickets", "Admin")">
                        <i class="bi bi-x-circle"></i> Reset All Filters
                    </a>
                </div>
            </form>
        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>No tickets found.</strong> Try adjusting your filters or create a new ticket.
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 25%;">Title</th>
                                <th scope="col" style="width: 15%;">Project</th>
                                <th scope="col" style="width: 12%;">Priority</th>
                                <th scope="col" style="width: 12%;">Status</th>
                                <th scope="col" style="width: 15%;">Created By</th>
                                <th scope="col" style="width: 15%;">Created At</th>
                                <th scope="col" class="text-end" style="width: 6%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @functions {
                                string GetStatusBadge(string status)
                                {
                                    return status switch
                                    {
                                        "Open" => "badge bg-primary",
                                        "In Progress" => "badge bg-info",
                                        "Resolved" => "badge bg-success",
                                        "Closed" => "badge bg-secondary",
                                        _ => "badge bg-light text-dark",
                                    };
                                }

                                string GetPriorityBadge(string priority)
                                {
                                    return priority switch
                                    {
                                        "High" => "badge bg-danger",
                                        "Medium" => "badge bg-warning text-dark",
                                        "Low" => "badge bg-success",
                                        "Critical" => "badge bg-dark",
                                        _ => "badge bg-light text-dark",
                                    };
                                }

                                string GetRowHighlight(string status)
                                {
                                    return status switch
                                    {
                                        "Open" => "",
                                        "In Progress" => "table-info table-opacity",
                                        "Resolved" => "table-success table-opacity",
                                        "Closed" => "table-secondary table-opacity",
                                        _ => "",
                                    };
                                }
                            }

                            @foreach (var t in Model)
                            {
                                <tr class="@GetRowHighlight(t.Status)">
                                    <td>
                                        <strong>@t.Title</strong>
                                    </td>
                                    <td>
                                        @if (t.Project != null)
                                        {
                                            <span class="badge bg-light text-dark">@t.Project.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="@GetPriorityBadge(t.Priority)">@t.Priority</span>
                                    </td>
                                    <td>
                                        <span class="@GetStatusBadge(t.Status)">@t.Status</span>
                                    </td>
                                    <td>
                                        @if (t.CreatedBy != null)
                                        {
                                            <small>@t.CreatedBy.FirstName @t.CreatedBy.LastName</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <small class="text-muted">@t.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</small>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a class="btn btn-outline-primary" href="@Url.Action("EditTicket", "Admin", new { id = t.Id })" title="Edit ticket">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a class="btn btn-outline-info" href="@Url.Action("TicketDetails", "Admin", new { id = t.Id })" title="View details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>
